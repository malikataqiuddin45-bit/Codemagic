workflows:
  debug-apk:
    name: Debug APK Build (Expo 54 macOS safe)
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      vars:
        CI: true
        EXPO_NO_INTERACTIVE: 1
      node: 20.12.2
      java: 17
    scripts:
      - name: üîß Install dependencies
        script: |
          npm install -g expo-cli
          npm install
          npm install --save-dev jetifier
          npx jetify || true

      - name: üèóÔ∏è Expo prebuild (clean)
        script: |
          npx expo prebuild --platform android --clean
          cd android
          chmod +x gradlew

      - name: üß© Pin Gradle & Kotlin (Perl patch)
        script: |
          cd android
          perl -pi -e 's#distributionUrl=.*#distributionUrl=https://services.gradle.org/distributions/gradle-8.6-bin.zip#g' gradle/wrapper/gradle-wrapper.properties || true
          perl -pi -e 's/ext\.kotlin_version\s*=.*/ext.kotlin_version = "1.9.22"/g' build.gradle || true

      - name: ü©π Patch Expo autolinking
        script: |
          PLUG_DIR="node_modules/expo-modules-autolinking/android/expo-gradle-plugin"
          if [ -d "$PLUG_DIR" ]; then
            find "$PLUG_DIR" -name "SettingsManager.kt" -print0 | while IFS= read -r -d '' f; do
              perl -pi -e 's/\<extensions\>/project.extensions/g' "$f" || true
              perl -pi -e 's/\<extra\>/project.extra/g' "$f" || true
            done
          fi

      - name: üßπ Build Debug APK
        script: |
          cd android
          ./gradlew clean
          ./gradlew :app:assembleDebug --no-daemon --warning-mode all --stacktrace

    artifacts:
      - android/app/build/outputs/**/*.apk
